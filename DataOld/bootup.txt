# setup filter 01


# set meta data
# post barrel un-distort
setuniform mancity01 MaskTopLeft=0.37x0.51
setuniform mancity01 MaskTopRight=0.66x0.52
setuniform mancity01 MaskBottomRight=1.0x0.73
setuniform mancity01 MaskBottomLeft=0.09x0.67

setuniform mancity01 RadialDistortionX=-.0900000036
setuniform mancity01 RadialDistortionY=.00999999978
setuniform mancity01 TangentialDistortionX=.0599999987
setuniform mancity01 TangentialDistortionY=0
setuniform mancity01 K5Distortion=0
setuniform mancity01 LensOffsetX=.0299999993
setuniform mancity01 LensOffsetY=.0500000007


# testing re distortion
#setuniform mancity01 RadialDistortionX=0
#setuniform mancity01 RadialDistortionY=0
#setuniform mancity01 TangentialDistortionX=0
#setuniform mancity01 TangentialDistortionY=0
#setuniform mancity01 K5Distortion=0
#setuniform mancity01 LensOffsetX=0
#setuniform mancity01 LensOffsetY=0
#setuniform mancity01 MaskTopLeft=0.385x0.544
#setuniform mancity01 MaskTopRight=0.668x0.62
#setuniform mancity01 MaskBottomRight=0.682x0.640
#setuniform mancity01 MaskBottomLeft=0.3x0.635


setuniform mancity01 RectMergeMax=50
setuniform mancity01 AtlasWidth=128 AtlasHeight=512

setuniform mancity01 BarrelPower=0.413

addstage mancity01 undistort vert=ScreenQuad.vert frag=DistortFisheye.frag Tex0=Frame NoSnapshot=true ZoomUv=1.0
#addstage mancity01 redistorttest vert=ScreenQuad.vert frag=DistortFisheye.frag Tex0=undistort NoSnapshot=true ZoomUv=1.0  Invert=1
#addstage mancity01 debuguv vert=ScreenQuad.vert frag=DebugUv.frag
addstage mancity01 crop vert=ScreenQuad.vert frag=Crop.frag Tex0=undistort
addstage mancity01 Hsl vert=ScreenQuad.vert frag=RgbToHsl.frag
addstage mancity01 SegmentedHsl cl=PatchFilter.cl kernel=GroupHsl
addstage mancity01 grassfilter cl=PatchFilter.cl kernel=FilterColourPatch
addstage mancity01 grassfilled cl=AlphaFill.cl kernel=AlphaFill_GreenRed

#gr I think this needs to be a barrel
#addstage mancity01 DistortMask vert=ScreenQuad.vert frag=DistortMask.frag
addstage mancity01 DistortMask vert=ScreenQuad.vert frag=DistortFisheye.frag Tex0=grassfilled Invert=1

addstage mancity01 rectfilter cl=CylinderFilter.cl kernel=FindLooseMinMaxs
# draw rects from filter
addstage mancity01 DrawRects cl=GatherRects.cl kernel=DrawFilterRects

addstage mancity01 GatherMinMaxs StageType=GatherRects cl=GatherRects.cl kernel=GatherMinMaxs SkipRender=true
#addstage mancity01 DistortRects cl=GatherRects.cl kernel=DistortMinMaxs MinMaxDataStage=GatherMinMaxs
addstage mancity01 DistortRects StageType=DistortRects cl=GatherRects.cl kernel=DistortMinMaxsFisheye MinMaxDataStage=GatherMinMaxs SkipRender=true
addstage mancity01 MakeRectAtlas StageType=MakeRectAtlas Rects=DistortRects Image=Frame Mask=DistortMask
##addstage mancity01 Segmentation cl=PatchFilter.cl kernel=BlurColour
##addstage mancity01 Centroids cl=PatchFilter.cl kernel=FindCentroids
##addstage mancity01 CentroidsDilated cl=AlphaFill.cl kernel=AlphaFill_Centroids

# show distorted/merged rects
#addstage mancity01 DrawDistortedMinMaxs StageType=DrawMinMax ClearFrag=Frame MinMaxSource=DistortRects cl=GatherRects.cl kernel=DrawMinMax
addstage mancity01 DrawDistortedMinMaxs StageType=DrawMinMax ClearFrag=undistort MinMaxSource=DistortRects cl=GatherRects.cl kernel=DrawMinMax

addstage mancity01 WriteRectAtlasGif StageType=WriteGif Source=MakeRectAtlas Filename=/Volumes/Code/PopTrackFootball/Unity/Assets/StreamingAssets/ManCity_Camera1_Atlas.gif SkipRender=true
addstage mancity01 WriteRectAtlasSrt StageType=WriteAtlasMeta Source=MakeRectAtlas Filename=/Volumes/Code/PopTrackFootball/Unity/Assets/StreamingAssets/ManCity_Camera1_Atlas.srt SkipRender=true
#addstage mancity01 WriteRectAtlasStream StageType=WriteRectAtlasStream AtlasStage=MakeRectAtlas Filename=../Output/ManCity_Camera1_Atlas.rectatlasstream SkipRender=true
decode mancity01 /Volumes/Assets/LiveLikeVideo/ManCity_Camera1.mp4

#addstage mancity01 WriteRectAtlasStream AtlasStage=MakeRectAtlas Filename=/Volumes/Code/PopTrack/VideoAugmentation/Assets/StreamingAssets/ManCity_Camera1.rectatlasstream
#decode mancity01 /Volumes/Code/PopTrack/VideoAugmentation/Assets/StreamingAssets/ManCity_Camera1.mp4






# line detector
#addstage LineDetector DebugUv vert=ScreenQuad.vert frag=DebugUv.frag
#addstage LineDetector Hsl vert=ScreenQuad.vert frag=FrameToHsl.frag
#addstage LineDetector CornerFilter cl=CornerFilter.cl kernel=CornerFilter
#loadframe LineDetector time=1001 input01_undistorted.png
#decode LineDetector /Volumes/Code/PopTrack/VideoAugmentation/Assets/StreamingAssets/ManCity_Camera1_126.mp4


